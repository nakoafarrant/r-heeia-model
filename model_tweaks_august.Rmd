---
title: "Test model with sensitivity"
output: html_document
---

As f


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F}
library(deSolve)
library(ggplot2)
library(schoolmath)
library(tidyverse)
library(TropFishR)
require(MASS)
require(dplyr)
library(colorspace)
library(MLmetrics)
library(lubridate)
library(knitr)
library(kableExtra)
library(FishLife)
library(FME)
```



```{r}
# The below values are characteristic of Mugil cephalus (striped mullet, ‘ama‘ama) as defined in the S.I. of Cheung, et al. 2013, who derived these values from data that is freely available at fishbase.org
Linf_mugil = 60 # asymptotic length for Mugil cephalus, [cm]
K_mugil = 0.27 # von Bertalanffy growth parameter, [1/year]
a_mugil = 0.032 # This a is specific to M. cephalus in Hawai'i estuaries (Peyton, et al. 2015) The a length-weight conversion parameter for overall M.cephauls on fishbase is 0.0085
b_mugil = 3.03 # This b is specific to M. cephalus in Hawai'i estuaries (Peyton, et al. 2015). For general fishbase, the length-weight conversion parameter is b = 3 for M. cephalus
Winf_mugil = a_mugil*Linf_mugil^b_mugil # asymptotic weight using length-weight conversion [grams]
# Using the Pauly 1979 empirical equation for t0 from fishbase. Seems to be log10 and not ln because other instances on the fishbase page explicityly use ln.
t0_mugil = -exp(-0.3922-0.2752*log10(Linf_mugil)-1.038*log10(K_mugil))

```

```{r, message=FALSE}
# USGS Stream Gauge #16275000 He'eia Stream at Haiku Valley near Kaneohe, Oahu, HI
# Data originally collected in cubic feet per second and converted to m^3 / day
# Data can be found at: https://waterdata.usgs.gov/nwis/monthly?referred_module=sw&amp;site_no=16275000&amp;por_16275000_41087=2643571,00060,41087,1914-02,2019-05&amp;format=html_table&amp;date_format=YYYY-MM-DD&amp;rdb_compression=file&amp;submitted_form=parameter_selection_list
daily_stream <- read_csv('heeia_stream_daily.csv') 

st_clean <- daily_stream %>% 
  mutate(mean = mean_va*0.028*1.157*10^5) %>% # variable to convert mean flow from ft^3/s to m^3/d
  mutate(date = as.Date(paste(month, day, sep = "-"), "%m-%d")) %>% # this attaches the 2019 year even though these are average flow rates from 1914 to 2019
  filter(date != 2019-02-29) %>%  # remove Feb 29 that's only present in leap years
  mutate(JD = 1:366) %>% # create Julian Day variable
  dplyr::select(date, JD, mean)


# Monthly solar irradiance [W/m^2] near He‘eia Fishpond based on Univ. of Hawai'i data
# Monthly solar radiation rasters provided the data at the point 157.808ºW, 21.435ºN
# Data source: solar.geography.hawaii.edu/downloads.html
daily_solar <- read_csv('solar_irrad.csv') 

```

```{r, message=FALSE}
# Read in water quality data from 2014-2015 in He'eia Fishpond CSV
heeia_wq = read_csv('heeia_wq_data_2014_2015.csv') %>% 
  arrange(date) %>% 
  dplyr::select(date:turbidity)

```


```{r}
# Read in Heeia fishpond temperature data
temp_surface <- heeia_wq %>% 
  dplyr::select(date, statistic, temp_surface) %>% 
  filter(statistic == "Mean" | statistic == "Stdv" | statistic == "N") %>% 
  spread(key = statistic, value = "temp_surface")  %>% 
  dplyr::rename(temps = Mean, temps_sd = Stdv) %>% 
  na.omit()

temp_bottom <- heeia_wq %>% 
  dplyr::select(date, statistic, temp_bottom) %>% 
  filter(statistic == "Mean" | statistic == "Stdv" | statistic == "N") %>% 
  spread(key = statistic, value = "temp_bottom")  %>% 
  dplyr::rename(tempb = Mean, tempb_sd = Stdv) %>% 
  na.omit()

```

```{r}
# calculate monthly average temperature
temp_full <- merge(temp_surface, temp_bottom, by="date") %>% 
  mutate(temp_avg = (temps + tempb)/2)
  
temp_summ <- temp_full %>% 
  mutate(month = month(as.POSIXlt(mdy(date)))) %>% 
  group_by(month) %>% 
  summarize(temp_mean = mean(temp_avg), temp_sd = sd(temp_avg), n = n())
```


```{r}
years = 300

yr_ct = rep(0:years, each = 365*4)

g_a = vector(mode = "numeric", length = length(t)) # don't think this gets used

# define physical parameters of ecosystem 
h_st = 0.5 # [m] average depth of stream 
l_st = 700 # [m] length of interest for He‘eia Stream
w_st = 15 # [m] approximate width of stream

A_fp = 360000 # [m^2] area of fishpond
h_fp = 0.4 # [m] average depth of fishpond water column [m]

A_sed = 360000 # [m^2] area of sediment below fishpond water column
h_sed = 0.005 # [m] depth of sediment of interest in meters

# define volumes of model's three physical compartments [m^3]
V_st = h_st*l_st*w_st # stream
V_fp = A_fp*h_fp # fishpond water
V_sed = A_sed*h_sed # fishpond sediment


# fish and algae rates and constants

FA = 1450/1000/4 # [kJ g fish^-1 6h^-1] energy consumed per gram of M. cephalus every 6 hours from FAO website says maximum growth rate is 1447 kJ/kg BW daily and 126 kJ/kg BW for maintenance

eff = 0.6 # one estimate of feed conversion efficiency for M. cephalus (assimilates 60% of the food it consumes)
alg_energy = 17.6 # [kJ g^-1 algae] energy per gram of Nannochloropsis spp. from Rebolloso-Fuentes, et al 2001
      # microplankton energy density 8 kJ g^-1 in Mediterranean (Barroeta, et al 2017). Whyte 1987 seems to further support ~8 kJ g^-1

# FISH EGESTION AND EXCRETION ENERGY AND MASS PARAMETERS
      a_eg = 0.16 # egested fraction of consumption from Megrey, et al. 2007 (0.16 recommended by source)
      a_ex = 0.1 # excreted percentage of consumed food that isn't egested from Megrey, et al. 2007 (0.1 recommended by source)
      
      eg = a_eg*FA/alg_energy # [g alg g fish^-1 6hr^-1] egestion rate
      l_fingerling = 3 # [cm] stock pond using 3cm fingerlings of M. cephalus
      fingerling_mass = a_mugil*l_fingerling^b_mugil # [g] approximate mass of fingerlings at time of stocking
      
      adult_energy = 7.8 #[kJ/g Wet Mass] energy content of 23 cm adult mugil cephalus which is about a 390 g fish which is 3040 kJ per fish from Marais and Erasmus, 1977
      # alternative energy content conversion for M. cephalus on Fishbase under the "Mass Conversion" tab: 5.3 kJ/g WM

# acquire the various life history parameters for M. cephalus from FishLife R package
Predict_mugil = Plot_taxa(Search_species(Genus="Mugil",Species = "cephalus")$match_taxonomy, mfrow=c(2,2))

# extract the bias corrected intrinsic growth rate, r [1/yr], for M. cephalus from the FishLife model
# this is a fair amount higher than other estimates of intrinsic growth rate
r_mugil_est = exp(Predict_mugil[[1]]$Mean_pred["r"]+0.5*diag(Predict_mugil[[1]]$Cov_pred)["r"]) %>% as.numeric() 

# extract the bias corrected mortality coefficient for M. cephalus from fishlife, 0.334 1/yr is on par with other estimates (0.346 1/yr from Then empirical formula)
M_mugil_est = exp(Predict_mugil[[1]]$Mean_pred["M"]+0.5*diag(Predict_mugil[[1]]$Cov_pred)["M"]) %>% 
  as.numeric()/365/4 # [1/6hr] 

# The fishing rate for the MSY had been predicted in FishLife as ln_Fmsy. That value was bias-corrected that and then exponentiated to get the Fmsy calculated below
# this is a fair amount larger than F suggested by other studies (0.343), but it does align with F_msy from other modeling approaches (see vggf flile)
Fmsy_mugil_est = exp((exp(Predict_mugil[[1]]$Mean_pred["ln_Fmsy"]+0.5*diag(Predict_mugil[[1]]$Cov_pred)["ln_Fmsy"]) %>% 
  as.numeric()))/365/5 # [1/6hr] maximum sustainable fishing rate

Temp = 25 # ºC, need to double check theaverage temperature from Kiana's data

 # Nitrogen reaction rates
      k_oa = 0.1/4 # [1/6hr] conversion of organic N to ammonium N
      k_ao = 0.1/4 # [1/6hr] conversion of ammonium N to organic N 
      k_nit = 0.5/4 # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      k_nit_red = 0.5/4 # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      k_av = 0.7/4 # [1/6hr] ammonium to ammonia (gas) volatilization rate
      k_nit_sed = 0.05/4 # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      k_denit = 0.01/4 # [1/6hr] denitrification rate (nitrate to N2 gas)
    
      
  
      
      # Fishpond water-sediment exchange rate constants
      k_r = 0.1/4 # [1/6hr] resuspension rate
      k_s = 0.8/4 # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      k_b = 0.001/4 # [1/6hr] burial removal rate [1/6hr] 
      
      r_NChl = 0.2 # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      k_ra = 0.1/4 #0.025/4, # [1/6hr] algae respiration rate
      k_ag = 1.5/4 # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      # K for mullet is 0.27 1/yr -> 0.0007 1/day, this is lower than the current growth rate but the current growth rate also seems particularly low
      k_ad = 0.09/4 # [1/6hr] rate of algae death, Jamu and Piedrahita, 0.01-0.09 1/d range
      
      
      # From Barman, Jana, Garg, Bhatnagar, https://link.springer.com/article/10.1007/s10499-004-2479-5
      # growth rate for M. cephalus in salinity 20 ppt 0.69 g/d or 0.67 g/d in 25 ppt
      # SGR --specific growth rate of weight-- (% BW (in grams) per day) about 4% per day
      k_birth = 0.35/365/4 # [1/6hr]
      
      # nitrogen concentrations in ocean - units g/m^3
      No_ocean = 0.001 # need to revisit these parameters. https://www.sciencedirect.com/science/article/pii/S030438000500164X#bib30 is a good source or Smith et al 1981
      Na_ocean = 0.0024 # also maybe a little high. Some data from Kaneohe bay indicates 0.002. Used to be 0.04 in the model
      Ni_ocean = 0.0068 # this may even be a little high relative to the bay being closer to 0.005 g/m^3. Used to be 0.02
      
      # water volume flux rate (m^3/6hr)
      sp_fl= 191660/4
      sp_ebb = -174880/4
      np_fl = 141384/4
      np_ebb = -159938/4
      
      r_mugil = r_mugil_est
      M_mugil = M_mugil_est
      Fmsy_mugil = Fmsy_mugil_est
      
      # historic estimated yields of 33-56 g/m^2/yr (300-500 lb/acre)
      # minimum yield for Oahu is 33.6 g/m^2
      
      historic_MSY_min = 33 # g/m^2/yr, minimum MSY for history yields
      historic_MSY_max = 56 # g/m^2/yr, maximum MSY for historic yields
      historic_MSY_avg = (historic_MSY_max + historic_MSY_min)/2
      
      # FISH CONSUMPTION ENERGY AND MASS PARAMETERS
      # 126 kJ gross energy (GE) / kg body weight for daily maintenance but 1446.7 kJ GE / kg BW is recommended for maximum growth
      
      # estimate carrying capacity for phytoplankton. At minimum there has to be enough algae to support the historic fish yields
      # there were also possible sources of food so alg doesn't need to account for all of the calories consumed, but also need to account for inefficiencies in use of food that is consumed
      
      
      # not in love with the initial version of the calculation below. Might want to find a way to actually do it with the carrying capacity
      K_alg = historic_MSY_max*FA*365*4/eff/alg_energy # g alg / (m^2)
      
      
      K_hs_fish = 2*10^5*14/A_fp
        #10^-7*10^10*10^-3 # g/m^2, half-saturation for fish consuming algae, suggested value from https://www.sciencedirect.com/science/article/pii/S2351989414000420 converted from kg/L to kg/km^2 to g/m^2
   
      RQ = 0.82 # respiration coefficient from Serpa, et al, 2013 dimensionless
      
      FCR = 4.6 # feed conversion ratio inputs/outputs [alg/fish]. average 3.6-5.6 for 3% and 5% BW feeding ratios. This at 4.6 FCR could be high compared to some other studies
      
      c_mw = 12.011 # [g] atomic weight of carbon
      o2_mw = 32 # [g] molecular weight of oxygen gas
      c_energy = 373 # [kJ mol C^-1]
      
      alg_CN = 6.6 # ratio of C:N in algae based on the Refield ratio 106:16
      
      
      exc = a_ex*(FA/alg_energy - eg) # [g alg g fish^-1 6hr^-1] excretion rate
      
      # FISH DENSITY
      fingerling_energy = adult_energy*fingerling_mass # [kJ per fingerling]
      
      Fcarr = 56 # [g/m^2] carrying capacity for fish in He‘eia Fishpond, 500 pounds per acre

      # NITROGEN LOADING
      LU_No = 1.8 # [g/m^3] organic N concentration in wetland for current land use
      LU_Na = 0.07 # [g/m^3] ammonium N concentration in wetland for current land use
      LU_Ni = 0.07 # [g/m^3] nitrate N concentration in wetland for current land use
      
      K_min = historic_MSY_min*4/r_mugil # g/m^2, minimum carrying capacity
      K_max = historic_MSY_max*4/r_mugil # g/m^2, maximum carrying capacity
      K_avg = (K_min + K_max)/2 # g/m^2, average carrying capacity
      
      # Nitrogen loading from submarine groundwater discharge. Estimated from Dulai, et al 2016
      # Total DIN SGD in Heeia FP is 53 mol/day that's split between Na and Ni and probably mostly Na
      SGD_Na = 0.815*53/4 # [mol Na/6hr] #SGD_Na = 670/4 # [g/6hr] NH4+ -N loaded into He'eia Fishpond
      SGD_Nn = 0.185*53/4 # [mol Nn/6hr] #SGD_Ni = 74/4 # [g/6hr] NO3- -N loaded into He'eia Fishpond
      
      # nitrogen concentrations in ocean - units g/m^3
      Na_bay = 0.0000982 # [mol/m^3] # also maybe a little high. Some data from Kaneohe bay indicates 0.002. Used to be 0.04 in the model
      Nn_bay = 0.000139 # [mol/m^3] based on center bay #0.0068 # this may even be a little high relative to the bay being closer to 0.005 g/m^3. Used to be 0.02
      DON_bay = 0.00772 #  [mol/m^3]
      PON_bay = 0.00281 # [mol/m^3] estimated from previous ratios of particulate to dissolved N in Kaneohe Bay
      
```

```{r}
# Parameterization for other land use scenarios
# Annual increases in loading of nitrogen forms to He‘eia Stream based on the potential upstream land uses. Here we use linear increases in loading for the restored and urban scenarios such that the 
pars_control = list(
      No_inc = 0, # [g/m^3]
      Na_inc = 0, # [g/m^3]
      Ni_inc = 0, # [g/m^3]
      
      # Nitrogen loading from submarine groundwater discharge. Estimated from Dulai, et al 2016
      SGD_Na = 0.815*53/4, # [mol Na/6hr] #SGD_Na = 670/4 # [g/6hr] NH4+ -N loaded into He'eia Fishpond
      SGD_Nn = 0.185*53/4, # [mol Nn/6hr] #SGD_Ni = 74/4 # [g/6hr] NO3- -N loaded into He'eia Fishpond
      

      # nitrogen concentrations in ocean - units mol N/m^3
      Na_bay = 0.0000982, # [mol/m^3] # also maybe a little high. Some data from Kaneohe bay indicates 0.002. Used to be 0.04 in the model
      Nn_bay = 0.000139, # [mol/m^3] based on center bay #0.0068 # this may even be a little high relative to the bay being closer to 0.005 g/m^3. Used to be 0.02
      DON_bay = 0.00772, #  [mol/m^3]
      PON_bay = 0.00281, # [mol/m^3] estimated from previous ratios of particulate to dissolved N in Kaneohe Bay
      
      
      # water volume flux rate (m^3/6hr)
      sp_fl= 191660/4,
      sp_ebb = -174880/4,
      np_fl = 141384/4,
      np_ebb = -159938/4,
      
      r_mugil = r_mugil_est,
      M_mugil = M_mugil_est,
      Fmsy_mugil = Fmsy_mugil_est,
      

      K_avg = (K_min + K_max)/2, # g/m^2, average carrying capacity
      
      
      # FISH CONSUMPTION ENERGY AND MASS PARAMETERS
      # not in love with the initial version of the calculation below. Might want to find a way to actually do it with the carrying capacity
      K_alg = historic_MSY_max*FA*365*4/eff/alg_energy, # g alg / (m^2)

      K_hs_fish = 2*10^5*14/A_fp,
        #10^-7*10^10*10^-3 # g/m^2, half-saturation for fish consuming algae, suggested value from https://www.sciencedirect.com/science/article/pii/S2351989414000420 converted from kg/L to kg/km^2 to g/m^2

      # NITROGEN LOADING
      LU_No = 1.8, # [g/m^3] organic N concentration in wetland for current land use
      LU_Na = 0.07, # [g/m^3] ammonium N concentration in wetland for current land use
      LU_Ni = 0.07, # [g/m^3] nitrate N concentration in wetland for current land use
      
      
      k_oa = 0.1/4, # [1/6hr] conversion of organic N to ammonium N
      k_ao = 0.1/4, # [1/6hr] conversion of ammonium N to organic N 
      k_nit = 0.5/4, # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      k_nit_red = 0.5/4, # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      k_av = 0.7/4, # [1/6hr] ammonium to ammonia (gas) volatilization rate
      k_nit_sed = 0.05/4, # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      k_denit = 0.01/4, # [1/6hr] denitrification rate (nitrate to N2 gas)
      
      Temp = 25, # ºC, need to double check theaverage temperature from Kiana's data
  
      
      # Fishpond water-sediment exchange rate constants
      c_res = 0.74,
      c_reg = 0.4*0.26,
      c_reg1a = 0.815,
      c_reg1n = 0.184,
      
      k_r = 0.1/4, # [1/6hr] resuspension rate
      k_s = 0.8/4, # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      # k_s = 0.8/4 seemed to be working when made the draft for Ashley. The suggested value from the more complicated model is also 0.188 [1/6hr] which is very close to 0.8/4 = 0.2 [1/6hr]
      k_b = 0.001/4, # [1/6hr] burial removal rate [1/6hr] 
      
      r_NChl = 0.2, # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      k_ra = 0.1/4, #0.025/4, # [1/6hr] algae respiration rate
      k_ag = 1.5/4, # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      # K for mullet is 0.27 1/yr -> 0.0007 1/day, this is lower than the current growth rate but the current growth rate also seems particularly low
      k_ad = 0.09/4

)



pars_restored = list(
      No_inc = 0.22, # [g/m^3]
      Na_inc = 0.009, # [g/m^3]
      Ni_inc = 0.009, # [g/m^3]
      
      SGD_Na = 0.815*53/4, # [mol Na/6hr] #SGD_Na = 670/4 # [g/6hr] NH4+ -N loaded into He'eia Fishpond
      SGD_Nn = 0.185*53/4, # [mol Nn/6hr] #SGD_Ni = 74/4 # [g/6hr] NO3- -N loaded into He'eia Fishpond
      

      # nitrogen concentrations in ocean - units mol N/m^3
      Na_bay = 0.0000982, # [mol/m^3] # also maybe a little high. Some data from Kaneohe bay indicates 0.002. Used to be 0.04 in the model
      Nn_bay = 0.000139, # [mol/m^3] based on center bay #0.0068 # this may even be a little high relative to the bay being closer to 0.005 g/m^3. Used to be 0.02
      DON_bay = 0.00772, #  [mol/m^3]
      PON_bay = 0.00281, # [mol/m^3] estimated from previous ratios of particulate to dissolved N in Kaneohe Bay
      
      # water volume flux rate (m^3/6hr)
      sp_fl= 191660/4,
      sp_ebb = -174880/4,
      np_fl = 141384/4,
      np_ebb = -159938/4,
      
      r_mugil = r_mugil_est,
      M_mugil = M_mugil_est,
      Fmsy_mugil = Fmsy_mugil_est,
      

      K_avg = (K_min + K_max)/2, # g/m^2, average carrying capacity
      
      
      # FISH CONSUMPTION ENERGY AND MASS PARAMETERS
      # not in love with the initial version of the calculation below. Might want to find a way to actually do it with the carrying capacity
      K_alg = historic_MSY_max*FA*365*4/eff/alg_energy, # g alg / (m^2)

      K_hs_fish = 2*10^5*14/A_fp,
        #10^-7*10^10*10^-3 # g/m^2, half-saturation for fish consuming algae, suggested value from https://www.sciencedirect.com/science/article/pii/S2351989414000420 converted from kg/L to kg/km^2 to g/m^2

      # NITROGEN LOADING
      LU_No = 1.8, # [g/m^3] organic N concentration in wetland for current land use
      LU_Na = 0.07, # [g/m^3] ammonium N concentration in wetland for current land use
      LU_Ni = 0.07 # [g/m^3] nitrate N concentration in wetland for current land use

)

pars_restored_rates = c(
      No_inc = 0.22, # [g/m^3]
      Na_inc = 0.009, # [g/m^3]
      Ni_inc = 0.009, # [g/m^3] 
  
      k_oa = 0.1/4, # [1/6hr] conversion of organic N to ammonium N
      k_ao = 0.1/4, # [1/6hr] conversion of ammonium N to organic N 
      k_nit = 0.5/4, # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      k_nit_red = 0.5/4, # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      k_av = 0.7/4, # [1/6hr] ammonium to ammonia (gas) volatilization rate
      k_nit_sed = 0.05/4, # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      k_denit = 0.01/4, # [1/6hr] denitrification rate (nitrate to N2 gas)
      
      Temp = 25, # ºC, need to double check thea verage temperature from Kiana's data
  
      
      # Fishpond water-sediment exchange rate constants
      c_res = 0.74,
      c_reg = 0.4*0.26,
      c_reg1a = 0.815,
      c_reg1n = 0.184,
      
      k_r = 0.1/4, # [1/6hr] resuspension rate
      k_s = 0.8/4, # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      k_b = 0.001/4, # [1/6hr] burial removal rate [1/6hr] 
      
      r_NChl = 0.2, # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      k_ra = 0.1/4, #0.025/4, # [1/6hr] algae respiration rate
      k_ag = 1.5/4, # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      # K for mullet is 0.27 1/yr -> 0.0007 1/day, this is lower than the current growth rate but the current growth rate also seems particularly low
      k_ad = 0.09/4
)


pars_urban = list(
      No_inc = 0.56, # [g/m^3]
      Na_inc = 0.023, # [g/m^3]
      Ni_inc = 0.023, # [g/m^3]
      
      # Nitrogen loading from submarine groundwater discharge. Estimated from Dulai, et al 2016
      SGD_Na = 0.815*53/4, # [mol Na/6hr] #SGD_Na = 670/4 # [g/6hr] NH4+ -N loaded into He'eia Fishpond
      SGD_Nn = 0.185*53/4, # [mol Nn/6hr] #SGD_Ni = 74/4 # [g/6hr] NO3- -N loaded into He'eia Fishpond
      

      # nitrogen concentrations in ocean - units mol N/m^3
      Na_bay = 0.0000982, # [mol/m^3] # also maybe a little high. Some data from Kaneohe bay indicates 0.002. Used to be 0.04 in the model
      Nn_bay = 0.000139, # [mol/m^3] based on center bay #0.0068 # this may even be a little high relative to the bay being closer to 0.005 g/m^3. Used to be 0.02
      DON_bay = 0.00772, #  [mol/m^3]
      PON_bay = 0.00281, # [mol/m^3] estimated from previous ratios of particulate to dissolved N in Kaneohe Bay
      
      
      # water volume flux rate (m^3/6hr)
      sp_fl= 191660/4,
      sp_ebb = -174880/4,
      np_fl = 141384/4,
      np_ebb = -159938/4,
      
      r_mugil = r_mugil_est,
      M_mugil = M_mugil_est,
      Fmsy_mugil = Fmsy_mugil_est,
      

      K_avg = (K_min + K_max)/2, # g/m^2, average carrying capacity
      
      
      # FISH CONSUMPTION ENERGY AND MASS PARAMETERS
      # not in love with the initial version of the calculation below. Might want to find a way to actually do it with the carrying capacity
      K_alg = historic_MSY_max*FA*365*4/eff/alg_energy, # g alg / (m^2)

      K_hs_fish = 2*10^5*14/A_fp,
        #10^-7*10^10*10^-3 # g/m^2, half-saturation for fish consuming algae, suggested value from https://www.sciencedirect.com/science/article/pii/S2351989414000420 converted from kg/L to kg/km^2 to g/m^2

      # NITROGEN LOADING
      LU_No = 1.8, # [g/m^3] organic N concentration in wetland for current land use
      LU_Na = 0.07, # [g/m^3] ammonium N concentration in wetland for current land use
      LU_Ni = 0.07 # [g/m^3] nitrate N concentration in wetland for current land use

)

pars_urban_rates = c(
      No_inc = 0.56, # [g/m^3]
      Na_inc = 0.023, # [g/m^3]
      Ni_inc = 0.023, # [g/m^3]
  
      k_oa = 0.1/4, # [1/6hr] conversion of organic N to ammonium N
      k_ao = 0.1/4, # [1/6hr] conversion of ammonium N to organic N 
      k_nit = 0.5/4, # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      k_nit_red = 0.5/4, # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      k_av = 0.7/4, # [1/6hr] ammonium to ammonia (gas) volatilization rate
      k_nit_sed = 0.05/4, # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      k_denit = 0.01/4, # [1/6hr] denitrification rate (nitrate to N2 gas)
      
      Temp = 25, # ºC, need to double check theaverage temperature from Kiana's data
  
      
      # Fishpond water-sediment exchange rate constants
      c_res = 0.74,
      c_reg = 0.4*0.26,
      c_reg1a = 0.815,
      c_reg1n = 0.184,
      
      k_r = 0.1/4, # [1/6hr] resuspension rate
      k_s = 0.8/4, # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      k_b = 0.001/4, # [1/6hr] burial removal rate [1/6hr] 
      
      r_NChl = 0.2, # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      k_ra = 0.1/4, #0.025/4, # [1/6hr] algae respiration rate
      k_ag = 1.5/4, # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      # K for mullet is 0.27 1/yr -> 0.0007 1/day, this is lower than the current growth rate but the current growth rate also seems particularly low
      k_ad = 0.09/4
)


```

```{r}
solveFish <- function(pars, times = seq(0, 300, by = 1/365/4)) {
  fish_func6 <- function(times, state, pars) {
  with(as.list(c(state, pars)), {
    
    # create an integer counter variable, time is otherwise in 6 hr intervals
    step = times*365*4 
    
    # the current year is defined as the rounded up integer year value of the current time step
    yr_curr = ceiling(times) # e.g. t= 0.5 is considered year 1. t = 1.2 is considered year 2. 
    
    # define flow terms- m^3/d
    # initializing this model to conditions on Jan. 1, 2014.
    if (step %% 64 < 33){
      # start with the first 32 spring tide cycles
      if (as.integer(step) %% 2 == 0)
        # alternate between spring flood and spring ebb based on being an even or odd step
        Q_tide = sp_fl
      else
        Q_tide = sp_ebb
    }
    else{
      # shift to  32 neap tides
      if(as.integer(step) %% 2 == 0)
        # alternate between neap flood and neap ebb based on being an even or odd step
        Q_tide = np_fl
      else
        Q_tide = np_ebb
    }

    
    # Specify He'eia stream flow rates based on USGS gauge daily flow averages from 1914-2019
    # Q_st is defined below in units of m^3 / 6 hours from m^3 / day
    if(step %% 365 != 0)
      Q_st = st_clean$mean[step %% 365]/4 
    else
      Q_st = st_clean$mean[365]/4 # account for Dec 31 case when step = 365 so 365 %% 365 would equal 0
    
    # Use the number of years that have passed to determine the nitrogren loading based on the relative 
    #changes in the land use to the other land uses from the current condition. After 20 years, each of 
    # the scenarios will have reached their expected loading rate per that land use.
    if(times < 20){
      W_No = (LU_No + No_inc*yr_curr)*Q_st # loading rate of organic N into the stream
      W_Na = (LU_Na + Na_inc*yr_curr)*Q_st # loading rate of ammonium N into the stream
      W_Ni = (LU_Ni + Ni_inc*yr_curr)*Q_st # loading rate of nitrate N into the stream
    } else {
      W_No = (LU_No + No_inc*20)*Q_st # loading rate of organic N into the stream
      W_Na = (LU_Na + Na_inc*20)*Q_st # loading rate of ammonium N into the stream
      W_Ni = (LU_Ni + Ni_inc*20)*Q_st # loading rate of nitrate N into the stream
    }
      
      
    ## PHYTOPLANKTON GROWTH - primarily derived from Burford and Lorenzen 2002
    # growth rate: g = g_alg_max * L_light * L_N 
    # phytoplankton growth is at its maximum except when limited by light or nutrients (nitrogen)
    g_alg_max = 2/4 # [6 hr^-1] max phytoplankton growth rate for 6 hour period ~1.45 was used in the Lorenzen study and 
    # 1.5 is used elsewhere. 0.5 is used in the Turner NPC study. Smith Kaneohe Bay 1981 suggests growth rates of 0.7 day^1
    
    # phytoplankton Nitrogen assimilation rate is 0.003 mol/m^3/day according to Smith, et al. 1981
    
    # https://www.hindawi.com/journals/jmb/2013/684739/ suggests a max growth rate of 5.9 day^-1 for diatoms
    k_chl = 14 # [m^-1 g Chl ^-1] light extinction caused by Chl-a
    k_other = 2.5 # [m^-1] light extinction caused by non Chl-a factors
    c_chl = 30 #  ratio of carbon to Chl-a in algae by mass
    #k_ext = k_chl*alg/c_chl*A_fp + k_other# [m^-1] light extinction coefficient
    k_ext = 0.0138 # [m^-1] from Lorenzen, C.J., 1972
    z = h_fp/2 # [m] average depth of He‘eia Fishpond
    
    # Monthly solar irradiance [W/m^2] near He‘eia Fishpond based on Univ. of Hawai'i data
    if(step %% 365 != 0)
      I0 = daily_solar$irradiance[step %% 365]/4 
    else
      # account for Dec 31 case when step = 365 so 365 %% 365 would equal 0
      I0 = daily_solar$irradiance[365]/4  
  
    I_sat = 60 # [W/m^2] saturating sunlight intensity for phytoplankton growth. 
    # Converted from 275 μmol photons m−2 s−1 (Gao, et al, 2007) using this unit converter: 
    # http://www.egc.com/useful_info_lighting.php
    
    # Calculate light limitation factor
    L_light = exp(1)/k_ext*(exp(-I0/I_sat*exp(-k_ext*z))) - exp(-(I0/I_sat))
    
    k_SN <- 0.015 # [g/m^3] half saturation for nitrogen. 
    
    L_N <- (Na_fp + Ni_fp)/(Na_fp + Ni_fp + k_SN) # Nitrogen limiting component of algae growth
    
    N_Chl <- 13 # N/Chl-a ratio of algae

    #g_alg <- g_alg_max*L_light*L_N
    g_alg <- g_alg_max*L_N
    
    Ing <- FA/alg_energy # [g alg * g fish ^-1 * day^-1], 
    #ingestion rate of algae by fish based on M. cephalus anabolic requirements and energy density of algae
    
    # Fish density-  fish are reproducing after 2 years
    if (times > 2) {
      if(step %% 366 < 91 | step %% 366 > 334) { 
        catch_rate = 0 # Closed season (Dec 1 to March 31)
        # there should be fish mass losses due to reproduction
      }
      else{
        catch_rate = Fmsy_mugil # harvest after 2 years during times of year outside of the closed season
      }
    }
    else {
      catch_rate = 0 # no harvesting if there are no fish that are at least 2 years old
    }
    
   
    # Fishpond water ammonium [g/m^3]     
    dNa <- (W_Na + SGD_Na + Q_tide*(Na_ocean-Na))/V_fp - k_oa*No_fp - (k_ao+k_an + k_av)*Na + c_reg*c_regNa*N_sed + ((-g_alg + k_ra)*alg + (eg + exc)*fish)/alg_CN/h_fp*(Na/(Na+Nn))
    # Fishpond water nitrate [g/m^3]  
    dNn <- (W_Ni + SGD_Ni + Q_tide*(Nn_ocean-Nn))/V_fp + k_an*Na + c_reg*c_regNn*No_sd + (-g_alg + k_ra)*alg/alg_CN/h_fp*(Nn/(Na+Nn))
    # DON [g/m^3]
    dDON <- (W_PON*No_st + Q_tide*(No_ocean-No_fp))/V_fp + (-k_oa-k_s)*No_fp + k_ao*Na_fp + c_res*No_sd
    # PON [g/m^3]  
    dPON <- (W_PON*No_st + Q_tide*(No_ocean-No_fp))/V_fp + (-k_oa-k_s)*No_fp + k_ao*Na_fp + c_res*No_sd
    # Sediment N [g/m^3]   
    dNsd <- k_s*No_fp - (k_b+k_r)*No_sd + k_s*alg/alg_CN/h_fp*(No_fp/(Na_fp+No_fp))
   
    # Algae density [g/m^2]
    dalg <- alg*(g_alg*(1-alg/K_alg) - k_s + k_ra) - Ing*alg*fish/(alg + K_hs_fish)
    
    dfish <- 1/FCR*Ing*alg*fish/(alg + K_hs_fish)*(1-fish/K_avg) - M_mugil*fish - catch_rate*fish 
    
    # Dry mass to wet mass ratio is 0.283 (DM/WM)
    # Energy content 18.778 J/mg DM (1 J = 2.39e-4 kcalories) # fishbase Conversion factors
    
    # some suggestions of mass composition of farmed M. cephalus (% of DM)
    #https://www-sciencedirect-com.proxy.library.ucsb.edu:9443/science/article/pii/S0044848612000658
    # Crude protein = 64-66%
    # Lipid: 7.9-8.3%
    # Ash: 17-19%
    # NFE (Nitrogen free extract): 7.4-11.3% (NFE = 100 - (crude protein + lipid + ash))
    
    # information on fatty acid and amine composition
    #https://www.researchgate.net/profile/Rabab_Salem3/publication/326083419_Characterization_of_Microbiological_and_Nutritional_Variations_in_Processed_Mullet_Mugil_cephalus_Fish/links/5b4a5377a6fdccadaecb9591/Characterization-of-Microbiological-and-Nutritional-Variations-in-Processed-Mullet-Mugil-cephalus-Fish.pdf
      
    return(list(c(Na = dNa, Nn = dNn, DON = dDON, PON = dPON, Nsd = dNsd, alg = dalg, fish = dfish), caught = catch_rate*fish))

})
}

state <- c(
  Na = 0.001663, # [mol N/m^3] 0.03 [g/m^3] stream initial ammonium  
  Ni = 0.011, # [mol N/m^3] 0.68 [g/m^3] stream initial nitrate         
  DON = 0.00628, # [mol N/m^3]
  PON = 0.00163, # [mol N/m^3] 0.1 [g/m^3] stream initial organic N
  Nsd = 98, # [mol N/m^3] 
  alg = 0.00896, #  # [g/m^2] model was working with alg = 0.5. Before it was 0.018. initial algae concentration based on average of data from Frank, et al, 2016 (0.0015 g Chl a/m^3) to g/m^2 algae. 0.0015 g Chla/m^3 * 30 carbon/Chl * 0.4m.
           # carbon to chlorophyll ratio (w/w) is 30 (Parsons et al 1984)
           # previously suggested algae to Chl ratio was 0.02 g algae/g Chla from the literature
           # range of conversion factors [g alg/g Chla] from Chapra 0.005-0.025. Would be 0.12 g/m^2 algae if used 0.005
  fish = 0.33 # [mol N/m^3] 10 [g/m^2] initial mullet  density (was 3.2)
  )

  return(ode(y = state, times = times, func = fish_func6, parms = pars, method = "euler"))
}
```

```{r}
out_control_new <- solveFish(pars = pars_control_rates)
#out_restored_new <- solveFish(pars = pars_restored_rates)
#out_urban_new <- solveFish(pars = pars_urban_rates)
```


```{r}
plot(out_control_new)
```

```{r}
plot(out_restored_new)
```

```{r}
plot(out_urban_new)
```

```{r}

parRanges_control <- data.frame(min = c(0, 0, 0, 670/4*.8, 74/4*.8, K_min, K_hs_fish*.8, LU_No*.8, LU_Na*.8, LU_Ni*.8, No_ocean*.8, Na_ocean*.8, Ni_ocean*.8, sp_fl*.8, sp_ebb*.8, np_fl*.8, np_ebb*.8, K_alg*.8, r_mugil*.8, M_mugil*.8, Fmsy_mugil*.8), 
                        max = c(0, 0, 0, 670/4*1.2, 74/4*1.2, K_max, K_hs_fish*1.2, LU_No*1.2, LU_Na*1.2, LU_Ni*1.2, No_ocean*1.2, Na_ocean*1.2, Ni_ocean*1.2, sp_fl*1.2, sp_ebb*1.2, np_fl*1.2, np_ebb*1.2, K_alg*1.2, r_mugil*1.2, M_mugil*1.2, Fmsy_mugil*1.2))

rownames(parRanges_control) <- c("No_inc", "Na_inc", "Ni_inc", "SGD_Na", "SGD_Ni", 
                         "K_avg", # carrying capacity for fish based on historic yield estimates
                         "K_hs_fish", # g/m^2, half-saturation for fish consuming algae
                         "LU_No", # [g/m^3] organic N concentration in wetland for current land use
                         "LU_Na", # [g/m^3] ammonium N concentration in wetland for current land use
                         "LU_Ni", # [g/m^3] nitrate N concentration in wetland for current land use
                         # nitrogen concentrations in ocean - units g/m^3
                         "No_ocean", 
                         "Na_ocean", 
                         "Ni_ocean",
                         # water volume flux rate (m^3/6hr)
                         "sp_fl",
                         "sp_ebb",
                         "np_fl",
                         "np_ebb",
                         "K_alg", # g alg / (m^2)
                         "r_mugil",
                         "M_mugil",
                         "Fmsy_mugil"
                         )

parRanges_control_rates <- data.frame(min = c(0, 0, 0, k_oa*.8, k_ao*.8, k_nit*.8, k_nit_red*.8, k_av*.8, k_nit_sed*.8, k_denit*.8, Temp*.8, k_r*.8, k_s*.8, k_b*.8, r_NChl*.8, k_ra*.8, k_ag*.8, k_ad*.8), 
                        max = c(0, 0, 0, k_oa*1.2, k_ao*1.2, k_nit*1.2, k_nit_red*1.2, k_av*1.2, k_nit_sed*1.2, k_denit*1.2, Temp*1.2, k_r*1.2, k_s*1.2, k_b*1.2, r_NChl*1.2, k_ra*1.2, k_ag*1.2, k_ad*1.2))

rownames(parRanges_control_rates) <- c("No_inc", "Na_inc", "Ni_inc",
  "k_oa", # [1/6hr] conversion of organic N to ammonium N
      "k_ao", # [1/6hr] conversion of ammonium N to organic N 
      "k_nit", # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      "k_nit_red", # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      "k_av", # [1/6hr] ammonium to ammonia (gas) volatilization rate
      "k_nit_sed", # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      "k_denit",
      
      "Temp", # ºC, need to double check theaverage temperature from Kiana's data
  
      
      # Fishpond water-sediment exchange rate constants
      "k_r", # [1/6hr] resuspension rate
      "k_s", # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      "k_b", # [1/6hr] burial removal rate [1/6hr] 
      
      "r_NChl", # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      "k_ra", #0.025/4, # [1/6hr] algae respiration rate
      "k_ag", # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      "k_ad"
)
```

```{r}

parRanges_restored <- data.frame(min = c(0.22*.8, 0.009*.8, 0.009*.8, 670/4*.8, 74/4*.8, K_min, K_hs_fish*.8, LU_No*.8, LU_Na*.8, LU_Ni*.8, No_ocean*.8, Na_ocean*.8, Ni_ocean*.8, sp_fl*.8, sp_ebb*.8, np_fl*.8, np_ebb*.8, K_alg*.8, r_mugil*.8, M_mugil*.8, Fmsy_mugil*.8), 
                        max = c(0.22*1.2, 0.009*1.2, 0.009*1.2, 670/4*1.2, 74/4*1.2, K_max, K_hs_fish*1.2, LU_No*1.2, LU_Na*1.2, LU_Ni*1.2, No_ocean*1.2, Na_ocean*1.2, Ni_ocean*1.2, sp_fl*1.2, sp_ebb*1.2, np_fl*1.2, np_ebb*1.2, K_alg*1.2, r_mugil*1.2, M_mugil*1.2, Fmsy_mugil*1.2))

rownames(parRanges_restored) <- c("No_inc", "Na_inc", "Ni_inc", "SGD_Na", "SGD_Ni", 
                         "K_avg", # carrying capacity for fish based on historic yield estimates
                         "K_hs_fish", # g/m^2, half-saturation for fish consuming algae
                         "LU_No", # [g/m^3] organic N concentration in wetland for current land use
                         "LU_Na", # [g/m^3] ammonium N concentration in wetland for current land use
                         "LU_Ni", # [g/m^3] nitrate N concentration in wetland for current land use
                         # nitrogen concentrations in ocean - units g/m^3
                         "No_ocean", 
                         "Na_ocean", 
                         "Ni_ocean",
                         # water volume flux rate (m^3/6hr)
                         "sp_fl",
                         "sp_ebb",
                         "np_fl",
                         "np_ebb",
                         "K_alg", # g alg / (m^2)
                         "r_mugil",
                         "M_mugil",
                         "Fmsy_mugil"
                         )

parRanges_restored_rates <- data.frame(min = c(0, 0, 0, k_oa*.8, k_ao*.8, k_nit*.8, k_nit_red*.8, k_av*.8, k_nit_sed*.8, k_denit*.8, Temp*.8, k_r*.8, k_s*.8, k_b*.8, r_NChl*.8, k_ra*.8, k_ag*.8, k_ad*.8), 
                        max = c(0, 0, 0, k_oa*1.2, k_ao*1.2, k_nit*1.2, k_nit_red*1.2, k_av*1.2, k_nit_sed*1.2, k_denit*1.2, Temp*1.2, k_r*1.2, k_s*1.2, k_b*1.2, r_NChl*1.2, k_ra*1.2, k_ag*1.2, k_ad*1.2))

rownames(parRanges_restored_rates) <- c("No_inc", "Na_inc", "Ni_inc",
  "k_oa", # [1/6hr] conversion of organic N to ammonium N
      "k_ao", # [1/6hr] conversion of ammonium N to organic N 
      "k_nit", # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      "k_nit_red", # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      "k_av", # [1/6hr] ammonium to ammonia (gas) volatilization rate
      "k_nit_sed", # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      "k_denit",
      
      "Temp", # ºC, need to double check theaverage temperature from Kiana's data
  
      
      # Fishpond water-sediment exchange rate constants
      "k_r", # [1/6hr] resuspension rate
      "k_s", # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      "k_b", # [1/6hr] burial removal rate [1/6hr] 
      
      "r_NChl", # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      "k_ra", #0.025/4, # [1/6hr] algae respiration rate
      "k_ag", # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      "k_ad"
)
```

```{r}
parRanges_urban <- data.frame(min = c(0.56*.8, 0.023*.8, 0.023*.8, 670/4*.8, 74/4*.8, K_min, K_hs_fish*.8, LU_No*.8, LU_Na*.8, LU_Ni*.8, No_ocean*.8, Na_ocean*.8, Ni_ocean*.8, sp_fl*.8, sp_ebb*.8, np_fl*.8, np_ebb*.8, K_alg*.8, r_mugil*.8, M_mugil*.8, Fmsy_mugil*.8), 
                        max = c(0.56*1.2, 0.023*1.2, 0.023*1.2, 670/4*1.2, 74/4*1.2, K_max, K_hs_fish*1.2, LU_No*1.2, LU_Na*1.2, LU_Ni*1.2, No_ocean*1.2, Na_ocean*1.2, Ni_ocean*1.2, sp_fl*1.2, sp_ebb*1.2, np_fl*1.2, np_ebb*1.2, K_alg*1.2, r_mugil*1.2, M_mugil*1.2, Fmsy_mugil*1.2))

rownames(parRanges_urban) <- c("No_inc", "Na_inc", "Ni_inc", "SGD_Na", "SGD_Ni", 
                         "K_avg", # carrying capacity for fish based on historic yield estimates
                         "K_hs_fish", # g/m^2, half-saturation for fish consuming algae
                         "LU_No", # [g/m^3] organic N concentration in wetland for current land use
                         "LU_Na", # [g/m^3] ammonium N concentration in wetland for current land use
                         "LU_Ni", # [g/m^3] nitrate N concentration in wetland for current land use
                         # nitrogen concentrations in ocean - units g/m^3
                         "No_ocean", 
                         "Na_ocean", 
                         "Ni_ocean",
                         # water volume flux rate (m^3/6hr)
                         "sp_fl",
                         "sp_ebb",
                         "np_fl",
                         "np_ebb",
                         "K_alg", # g alg / (m^2)
                         "r_mugil",
                         "M_mugil",
                         "Fmsy_mugil"
                         )

parRanges_urban_rates <- data.frame(min = c(0.56*.8, 0.023*.8, 0.023*.8, k_oa*.8, k_ao*.8, k_nit*.8, k_nit_red*.8, k_av*.8, k_nit_sed*.8, k_denit*.8, Temp*.8, k_r*.8, k_s*.8, k_b*.8, r_NChl*.8, k_ra*.8, k_ag*.8, k_ad*.8), 
                        max = c(0.56*1.2, 0.023*1.2, 0.023*1.2, k_oa*1.2, k_ao*1.2, k_nit*1.2, k_nit_red*1.2, k_av*1.2, k_nit_sed*1.2, k_denit*1.2, Temp*1.2, k_r*1.2, k_s*1.2, k_b*1.2, r_NChl*1.2, k_ra*1.2, k_ag*1.2, k_ad*1.2))

rownames(parRanges_urban_rates) <- c("No_inc", "Na_inc", "Ni_inc",
      "k_oa", # [1/6hr] conversion of organic N to ammonium N
      "k_ao", # [1/6hr] conversion of ammonium N to organic N 
      "k_nit", # [1/6hr] nitrification (ammonium N -> nitrate N) in water column
      "k_nit_red", # [1/6hr] reduction of nitrate N to ammonium N. Originally 0.1/4
      "k_av", # [1/6hr] ammonium to ammonia (gas) volatilization rate
      "k_nit_sed", # [1/6hr] nitrification (ammonium N -> nitrate N) rate in the sediment
      "k_denit",
      
      "Temp", # ºC, need to double check theaverage temperature from Kiana's data
  
      
      # Fishpond water-sediment exchange rate constants
      "k_r", # [1/6hr] resuspension rate
      "k_s", # [1/6hr] settling rate, used to be 0.05 /day. If going to make it this high, maybe it should just be related to phytoplankton settling rate due to their size. Burdoff and Lorenzen suggest 0.8 /day
      # figures look a little different with 0.05 /day but still retain generally the same shape
      "k_b", # [1/6hr] burial removal rate [1/6hr] 
      
      "r_NChl", # [g N/g Chla] ratio of nitrogen to Chl-a in algae
      "k_ra", #0.025/4, # [1/6hr] algae respiration rate
      "k_ag", # [1/d] algae growth rate constant at 20ºC
      #k_fg = 0.015/4, # rate of fish growth due to algae consumption [1/6hr]
      "k_ad"
)
```

```{r}
Sens_control <- summary(sensRange(func = solveFish, parms = pars_control, dist = "latin", sensvar = c("No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd", "alg", "fish"), parRange = parRanges_control, num = 100))
Sens_control_rates <- summary(sensRange(func = solveFish, parms = pars_control_rates, dist = "latin", sensvar = c("No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd", "alg", "fish"), parRange = parRanges_control_rates, num = 100))

Sens_restored <- summary(sensRange(func = solveFish, parms = pars_restored, dist = "latin", sensvar = c("No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd", "alg", "fish"), parRange = parRanges_restored, num = 100))
Sens_restored_rates <- summary(sensRange(func = solveFish, parms = pars_restored_rates, dist = "latin", sensvar = c("No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd", "alg", "fish"), parRange = parRanges_restored_rates, num = 100))

Sens_urban <- summary(sensRange(func = solveFish, parms = pars_urban, dist = "latin", sensvar = c("No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd", "alg", "fish"), parRange = parRanges_urban, num = 100))
Sens_urban_rates <- summary(sensRange(func = solveFish, parms = pars_urban_rates, dist = "latin", sensvar = c("No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd", "alg", "fish"), parRange = parRanges_urban_rates, num = 100))
```

```{r}
Sens_control_fish <- summary(sensRange(func = solveFish, parms = pars_control, dist = "latin", sensvar = c("fish"), parRange = parRanges_control, num = 100))
```


```{r}
plot(Sens_control_fish, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")
```


```{r}
plot(Sens_control, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")
plot(Sens_control_rates, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")


plot(Sens_restored, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")

plot(Sens_restored_rates, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")


plot(Sens_urban, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")

plot(Sens_urban_rates, xlab = "time, years", ylab = "g N/m^3", col = c("lightblue", "darkblue"), legpos="topright")


```
```{r}
Sens_control_df <- tibble::rownames_to_column(Sens_control, "VALUE")
```

```{r}
Sens_control_df$var <- ifelse(grepl("fish", Sens_control_df, ignore.case = T), "Fish", "Other")

Sens_control_df_fish <- Sens_control_df %>% 
  filter(var == "Fish")
```

```{r}
ggplot(Sens_control_df_fish, aes(x = x, y = Mean)) +
  geom_line() +
  geom_errorbar(aes(ymin = Mean-Sd, ymax=Mean+Sd), color = "blue")
```


```{r}
matplot(out_control_new[,1], out_control_new[,2:10], type = "l", lty = 1:9, col = "black", xlab = "time, years", ylab = "g N/m3")
legend("topright", c("No_st", "Na_st", "Ni_st", "No_fp", "Na_fp", "Ni_fp", "No_sd", "Na_sd", "Ni_sd"), lty = 1:3, lwd = c(2, 2, 1))
```

### Local sensitivity 
```{r}
Sns_control <- sensFun(func = solveFish, parms = pars_control, varscale = 1)
Sns_control_rates <- sensFun(func = solveFish, parms = pars_control_rates, varscale = 1)
```

```{r}
Sns_restored <- sensFun(func = solveFish, parms = pars_restored, varscale = 1)
Sns_restored_rates <- sensFun(func = solveFish, parms = pars_restored_rates, varscale = 1)
Sns_urban <- sensFun(func = solveFish, parms = pars_control, varscale = 1)
Sns_urban_rates <- sensFun(func = solveFish, parms = pars_control_rates, varscale = 1)
```




```{r}
# Control main parameters
Sns_control[, -c(1:2)] <- apply(Sns_control[, -c(1:2)], 2, function(x) as.numeric(x)) %>% 
  as.data.frame()
Sns_control_key = gather(Sns_control, key = "Parameter", value = "Sensitivity", -c("x", "var"))
# Control rate parameters
Sns_control_rates[, -c(1:2)] <- apply(Sns_control_rates[, -c(1:2)], 2, function(x) as.numeric(x)) %>% 
  as.data.frame()
Sns_control_rates_key = gather(Sns_control_rates, key = "Parameter", value = "Sensitivity", -c("x", "var"))

# Restored main parameters
Sns_restored[, -c(1:2)] <- apply(Sns_restored[, -c(1:2)], 2, function(x) as.numeric(x)) %>% 
  as.data.frame()
Sns_restored_key = gather(Sns_restored, key = "Parameter", value = "Sensitivity", -c("x", "var"))
# Restored rate parameters
Sns_restored_rates[, -c(1:2)] <- apply(Sns_restored_rates[, -c(1:2)], 2, function(x) as.numeric(x)) %>% 
  as.data.frame()
Sns_restored_rates_key = gather(Sns_restored_rates, key = "Parameter", value = "Sensitivity", -c("x", "var"))

# Urban main parameters
Sns_urban[, -c(1:2)] <- apply(Sns_urban[, -c(1:2)], 2, function(x) as.numeric(x)) %>% 
  as.data.frame()
Sns_urban_key = gather(Sns_urban, key = "Parameter", value = "Sensitivity", -c("x", "var"))
# Urban rate parameters
Sns_urban_rates[, -c(1:2)] <- apply(Sns_urban_rates[, -c(1:2)], 2, function(x) as.numeric(x)) %>% 
  as.data.frame()
Sns_urban_rates_key = gather(Sns_urban_rates, key = "Parameter", value = "Sensitivity", -c("x", "var"))
```

```{r}
# Examine the sensitivity of Ni_fp to different parameters
Sns_control_nit_df <- Sns_control_key %>% 
  filter(var == "Ni_fp") %>% 
  filter(x <20) %>% 
  filter(Parameter != "r_mugil" & Parameter != "No_inc" & Parameter != "Na_inc" & Parameter != "Ni_inc")

Sns_control_nit_rates_df <- Sns_control_rates_key %>% 
  filter(var == "Ni_fp")  %>% 
  filter(x < 20) %>% 
  filter(Parameter != "Temp" & Parameter != "r_NChl" & Parameter != "k_ag" & Parameter != "k_ad") # factors that nitrate showed zero sensitivity to
```

```{r}
Sns_nit_summ <- Sns_control_nit_df %>% 
  group_by(Parameter) %>% 
  summarise(mean_sns = mean(Sensitivity))

Sns_nit_rates_summ <- Sns_control_nit_rates_df %>% 
  group_by(Parameter) %>% 
  summarise(mean_sns = mean(Sensitivity))
```


```{r}
Sns_control_plot_nit <- ggplot(data = Sns_control_nit_df, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  #facet_wrap(~var) + 
  labs(title = "Sensitivity of Control scenario model with Non-rate parameters", x = "Time (Years)")

Sns_control_plot_nit
```

```{r}
Sns_control_nit_rates_plot <- ggplot(data = Sns_control_nit_rates_df, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  labs(title = "Sensitivity of Control scenario model with rate parameters", x = "Time (Years)")

Sns_control_nit_rates_plot
```
Ni_fp is by far most sensitive to the value of k_s (high negative sensitivity). About half as sensitive to each of the tide values. Negatively sensitive to the flood values and positively sensisitve to the ebb values. Higher magnitude changes for the spring tide conditions because they result in higher flux volume changes. Also some lower sensitivity to k_r (resuspension) and to the K_hs_fish (half saturation constant for fish consumption of algae)

# Examine the sensitivity of Na_fp to different parameters
```{r}

Sns_control_amm_df <- Sns_control_key %>% 
  filter(var == "Na_fp") %>% 
  filter(x <50)

Sns_control_amm_rates_df <- Sns_control_rates_key %>% 
  filter(var == "Na_fp")  %>% 
  filter(x < 50)
```

```{r}
Sns_amm_summ <- Sns_control_amm_df %>% 
  group_by(Parameter) %>% 
  summarise(mean_sns = mean(Sensitivity))

Sns_amm_rates_summ <- Sns_control_amm_rates_df %>% 
  group_by(Parameter) %>% 
  summarise(mean_sns = mean(Sensitivity))
```


```{r}
Sns_control_plot_amm <- ggplot(data = Sns_control_amm_df, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  #facet_wrap(~var) + 
  labs(title = "Sensitivity of Control scenario model with Non-rate parameters", x = "Time (Years)")

Sns_control_plot_amm
```

```{r}
Sns_control_amm_rates_plot <- ggplot(data = Sns_control_amm_rates_df, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  labs(title = "Sensitivity of Control scenario model with rate parameters", x = "Time (Years)")

Sns_control_amm_rates_plot
```


```{r}
Sns_control_fish_df <- Sns_control_key %>% 
  filter(var == "fish") %>% 
  filter(Parameter != "No_ocean" & Parameter != "Na_ocean" & Parameter != "Ni_ocean" & Parameter != "No_inc" & Parameter != "Na_inc" & Parameter != "Ni_inc")

Sns_control_fish_rates_df <- Sns_control_rates_key %>% 
  filter(var == "fish") %>% 
  filter(Parameter != "Temp" & Parameter != "r_NChl" & Parameter != "No_inc" & Parameter != "Na_inc" & Parameter != "Ni_inc")
```

```{r}
Sns_control_plot_fish <- ggplot(data = Sns_control_fish_df, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  #facet_wrap(~var) + 
  labs(title = "Sensitivity of Control scenario model with Non-rate parameters", x = "Time (Years)")

Sns_control_plot_fish
```


```{r}


Sns_control_fish_rates_plot <- ggplot(data = Sns_control_fish_rates_df, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  labs(title = "Sensitivity of Control scenario model with rate parameters", x = "Time (Years)")

Sns_control_fish_rates_plot
```



```{r}
Sns_control_plot <- ggplot(data = Sns_control_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Control scenario model with Non-rate parameters")

Sns_control_plot
# fish negatively sensitive to Fmsy_mugil (understandably because as that increases, fish population drops), also M_mugil (the mortality rate), and K_hs_fish (the half-saturation constant of fish consuming algae)
# No_sd negatively sensitive to np_fl and sp_fl; positively sensitive to LU_No and K_hs_fish
# No_st is very sensitive to LU_No

Sns_control_rates_plot <- ggplot(data = Sns_control_rates_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Control scenario model with rate parameters")

Sns_control_rates_plot

Sns_restored_plot <- ggplot(data = Sns_restored_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Restored scenario model with Non-rate parameters")

Sns_restored_plot
# fish negatively sensitive to Fmsy_mugil (understandably because as that increases, fish population drops), also M_mugil (the mortality rate), and K_hs_fish (the half-saturation constant of fish consuming algae)
# No_sd negatively sensitive to np_fl and sp_fl; positively sensitive to LU_No and K_hs_fish
# No_st is very sensitive to LU_No

Sns_restored_rates_plot <- ggplot(data = Sns_restored_rates_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Restored scenario model with rate parameters")

Sns_restored_rates_plot

Sns_urban_plot <- ggplot(data = Sns_urban_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Urban scenario model with Non-rate parameters")

Sns_urban_plot
# fish negatively sensitive to Fmsy_mugil (understandably because as that increases, fish population drops), also M_mugil (the mortality rate), and K_hs_fish (the half-saturation constant of fish consuming algae)
# No_sd negatively sensitive to np_fl and sp_fl; positively sensitive to LU_No and K_hs_fish
# No_st is very sensitive to LU_No

Sns_urban_rates_plot <- ggplot(data = Sns_urban_rates_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Urban scenario model with rate parameters")

Sns_urban_rates_plot
```


```{r}
Sns_restored_plot <- ggplot(data = Sns_restored_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Restored scenario model with Non-rate parameters")

Sns_restored_plot
# fish negatively sensitive to Fmsy_mugil (understandably because as that increases, fish population drops), also M_mugil (the mortality rate), and K_hs_fish (the half-saturation constant of fish consuming algae)
# No_sd negatively sensitive to np_fl and sp_fl; positively sensitive to LU_No and K_hs_fish
# No_st is very sensitive to LU_No

Sns_restored_rates_plot <- ggplot(data = Sns_restored_rates_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Restored scenario model with rate parameters")

Sns_restored_rates_plot
```

```{r}
Sns_urban_plot <- ggplot(data = Sns_urban_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Urban scenario model with Non-rate parameters")

Sns_urban_plot
# fish negatively sensitive to Fmsy_mugil (understandably because as that increases, fish population drops), also M_mugil (the mortality rate), and K_hs_fish (the half-saturation constant of fish consuming algae)
# No_sd negatively sensitive to np_fl and sp_fl; positively sensitive to LU_No and K_hs_fish
# No_st is very sensitive to LU_No

Sns_urban_rates_plot <- ggplot(data = Sns_urban_rates_key, aes(x = x, y = Sensitivity, col= Parameter)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~var) + 
  labs(title = "Sensitivity of Urban scenario model with rate parameters")

Sns_urban_rates_plot
```

```{r}
summary(Sns_control)
summary(Sns_control_rates)

summary(Sns_restored)
summary(Sns_restored_rates)

summary(Sns_urban)
summary(Sns_urban_rates)
```


```{r}
cor(Sns_control[,-(1:2)])
cor(Sns_control_rates[,-(1:2)])

cor(Sns_restored[,-(1:2)])
cor(Sns_restored_rates[,-(1:2)])

cor(Sns_urban[,-(1:2)])
cor(Sns_urban_rates[,-(1:2)])
```

```{r}
pairs(Sns_control) # this produces the square correlation plot across all of the different parameters
pairs(Sns_control_rates)

pairs(Sns_restored) # this produces the square correlation plot across all of the different parameters
pairs(Sns_restored_rates)

pairs(Sns_urban) # this produces the square correlation plot across all of the different parameters
pairs(Sns_urban_rates)
```


# Plots for paper 

```{r}
df_control <- as.data.frame(out_control_new) %>% 
  mutate(caught_kg = caught*A_fp/1e3)
df_restored <- as.data.frame(out_restored_new) %>% 
  mutate(caught_kg = caught*A_fp/1e3)
df_urban <- as.data.frame(out_urban_new) %>% 
  mutate(caught_kg = caught*A_fp/1e3)

fish_catch <- df_control %>% 
  dplyr::select(time, caught_kg) %>% 
  dplyr::rename(Current = caught_kg) %>% 
  mutate(Restored = df_restored$caught_kg, Urban = df_urban$caught_kg) %>% 
  gather('Current', 'Restored', 'Urban', key = "Scenario", value = "Mass_kg")

  
```

```{r}
catch_sum <- fish_catch %>% 
  group_by(Scenario) %>% 
  summarize(total_catch = sum(Mass_kg)/1e3) # [tons] was in g/m^2 at each time step. Sum the harvest at each time step and multiply by the area to get the mass. Convert to metric tons

# probably won't actually run it for 300 years at a time though. Likely just simulating much shorter periods of decades to a century
```



```{r}
# Make a fish density (g/m^2) plot

n_plot <- ggplot(data = fish_catch, aes(x = time, y = Mass_kg, col= Scenario)) +
  geom_line() +
  guides(fill=FALSE) +
  facet_wrap(~Scenario) +
  labs(title = "Modeled ‘Ama‘ama Catch From He'eia Fishpond", x = "Time (Years)", y = as.expression(bquote(Density (g/m^2)))) +
  theme(axis.text.x= element_text(size = 8, hjust = .2), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5), legend.title.align = 0.5)

n_plot
```


```{r}
# Make a fish time series plot
# a little useless of a plot 

catch_plot2 <- ggplot(data = fish_catch, aes(x = time, y = Mass_kg, col= Scenario)) +
  geom_line() +
  guides(fill=FALSE) +
  labs(title = "Modeled ‘Ama‘ama Catch From He'eia Fishpond", x = "Time (Years)", y = as.expression(bquote(Density (g/m^3)))) +
  theme(axis.text.x= element_text(size = 8, hjust = .2), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5), legend.title.align = 0.5)

catch_plot2
```



```{r}
# create a data frame of fishpond water column output to use in a figure
fp_df <- df_control %>% 
  dplyr::select(time, No_fp, Na_fp, Ni_fp, alg, fish) %>% 
  gather('No_fp', 'Na_fp', 'Ni_fp', 'alg', 'fish', key = "species", value = "concentration")

fp_df <- na.omit(fp_df)

neworder <- c('No_fp', 'Na_fp', 'Ni_fp', 'alg', 'fish')

fp_df2 <- arrange(transform(fp_df,
             species=factor(species,levels=neworder)),species) %>% 
  filter(time > 1400 & time <= 1420) %>% 
  mutate(days = (time -1400)*365)
```


```{r}
# Six-panel figure of different state variables output from control conditions in the model

fp_plot <- ggplot(data = fp_df2, aes(x = time-1400, y = concentration, col = species)) +
  facet_wrap(~species, scales = "free_y", 
                strip.position = "left", 
                labeller = as_labeller(c(alg = "Algae Density (g/m^2)", fish = "Fish Density (g/m^2)", Na_fp = "Ammonium-N (mg/L)", Ni_fp = "Nitrate-N (mg/L)", No_fp = "Organic N (mg/L)", caught_kg = 'Caught Fish (kg)'))) +
  geom_line() +
  labs(title = "Model Outputs in He'eia Fishpond Water Column\n", x = "Time (Years)") +
  ylab(NULL) +
  theme(axis.text.x= element_text(size = 8, hjust = .2), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5), strip.background = element_blank(),
           strip.placement = "outside", legend.position = "none") 
fp_plot
```
```{r}
fp_df2 %>% filter(time == 1420)
```


# Start running code chunks again here. 
Most of the chunks from when the outputs are converted into data frames until this point are not interesting until the fish models and catch variables are fixed
```{r}
fp_water_df <- df_control %>% 
  dplyr::select(time, No_fp, Na_fp, Ni_fp) %>% 
  gather('No_fp', 'Na_fp', 'Ni_fp', key = "nitrogen", value = "concentration")

```


#
```{r}
# Three-panel figure of different nitrogen variables from control conditions in the fishpond water
fp_over20 <- fp_water_df %>% 
  filter(time >= 20 & time < 30)

fp_over20_plot <- ggplot(data = fp_over20, aes(x = time, y = concentration, col=nitrogen)) +
  facet_wrap(~nitrogen, scales = "free_y", 
                strip.position = "left", 
                labeller = as_labeller(c(No_fp = "Organic N (mg/L)", Na_fp = "Ammonium-N (mg/L)", Ni_fp = "Nitrate-N (mg/L)"))) +
  geom_line() +
  labs(title = "Model Outputs in He'eia Fishpond Water Column\n", x = "Time (Years)") +
  ylab(NULL) +
  theme(axis.text.x= element_text(size = 8, hjust = .2), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5), strip.background = element_blank(),
           strip.placement = "outside", legend.position = "none") 
fp_over20_plot
```



# start running from here if want to see how the model compares to other data


```{r}
nitrate_data <- heeia_wq %>% 
  dplyr::select(date, statistic, nitrate) %>% 
  filter(statistic == "Mean" | statistic == "Stdv" | statistic == "N") %>% 
  spread(key = statistic, value = "nitrate") %>% 
  dplyr::rename(nit_obs = Mean, nit_sd = Stdv) %>% 
  mutate(nit_se = nit_sd / sqrt(N)) %>% 
  mutate(day_ct = 0, nit_var = nit_sd^2) %>% 
  na.omit() %>% 
  mutate(date = mdy(date)) %>% 
  arrange(date)


  for (i in 2:length(nitrate_data$day_ct)){
    nitrate_data$day_ct[i] = nitrate_data$day_ct[i-1] + as.integer(nitrate_data$date[i]-nitrate_data$date[i-1])
  }

nitrate_data_shift <- nitrate_data %>% 
  mutate(day_shft = day_ct + 147) # shift the day counter from starting at 0 on the first day of data collection to instead start on the Julian Day of that year (147 for May 27). Then the day counter increases from there based on the day since sampling began
  #mutate(JD = yday(date))

ammonium_data <- heeia_wq %>% 
  dplyr::select(date, statistic, ammonia) %>% 
  filter(statistic == "Mean" | statistic == "Stdv" | statistic == "N") %>% 
  spread(key = statistic, value = "ammonia") %>% 
  dplyr::rename(amm_obs = Mean, amm_sd = Stdv) %>% 
  mutate(amm_se = amm_sd / sqrt(N)) %>% 
  mutate(day_ct = 0, amm_var = amm_sd^2) %>% 
  na.omit() %>% 
  mutate(date = mdy(date)) %>% 
  arrange(date) %>% 
  filter(amm_obs != max(amm_obs)) # removed an outlier, could be related to a storm event. Could remove this line to add

  for (i in 2:length(ammonium_data$day_ct)){
    ammonium_data$day_ct[i] = ammonium_data$day_ct[i-1] + as.integer(ammonium_data$date[i]-ammonium_data$date[i-1])
  }

amm_data_shift <- ammonium_data %>% 
  mutate(day_shft = day_ct + 147) 


```



```{r}
fp_nitrate6 <- fp_water_df %>% 
  filter(nitrogen == "Ni_fp")

fp_ammonium6 <- fp_water_df %>% 
  filter(nitrogen == "Na_fp")
```

```{r}
# need to change the axis to be Jullian days and indicate which year

# compare two years of modeled fishpond nitrate to the 2014-2015 fishpond water nitrate data
fp_nitrate <- fp_water_df %>% filter(nitrogen == "Ni_fp") %>% 
  filter(time >= 1398 & time < 1400) %>% 
  mutate(days = (time-1398)*365) %>% 
  filter(days > 100 & days < 600)


nitate_compare_plot = ggplot() + 
  geom_point(data = nitrate_data_shift, aes(x = day_shft, y = nit_obs),colour='blue', show.legend = T) +
  geom_errorbar(data = nitrate_data_shift, aes(x = day_shft, ymin=nit_obs-nit_sd, ymax=nit_obs+nit_sd), width=3, col='blue', show.legend = T) +
  geom_line(data = fp_nitrate, aes(x = days, y = concentration), col = 'green') +
  labs(x = 'Julian Days from Jan.1, 2014', y = 'Concentration (mg/L)') +
  guides(fill=guide_legend()) +
  theme(axis.text.x= element_text(size = 8), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5))
  

nitate_compare_plot
```




```{r}
# compare two years of modeled fishpond ammonium N to the 2014-2015 fishpond water ammonium data
fp_amm <- fp_water_df %>% filter(nitrogen == "Na_fp") %>% 
  filter(time >= 1398 & time < 1400) %>% 
  mutate(days = (time-1398)*365) %>% 
  filter(days > 100 & days < 600)


amm_compare_plot = ggplot() +
  geom_line(data = fp_amm, aes(x = days, y = concentration), col = 'red') + 
  geom_point(data = amm_data_shift, aes(x = day_shft, y = amm_obs),col='magenta') +
  geom_errorbar(data = amm_data_shift, aes(x = day_shft, ymin=amm_obs-amm_sd, ymax=amm_obs+amm_sd), width=3, col='magenta') +
  labs(x = 'Julian Days from Jan.1, 2014', y = 'Concentration (mg/L)') +
  theme(axis.text.x= element_text(size = 8), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5))

amm_compare_plot
```
```{r}
fp_nit_analysis <- fp_nitrate6 %>% 
  filter(time >= 1398 & time < 1400)

fp_amm_analysis <- fp_ammonium6 %>% 
  filter(time >= 1398 & time < 1400)
```


Prepare the data to do the MSE/NSE analysis
```{r}
# need to average 4 times steps to get the average for that day. Assign a day number in integer form that can be compared against the days where there is data. Then make calculate MSE or some other metric for comparison



# create daily averages for nitrate concentrations modeled in the fishpond water
fp_nit_day <- data.frame(day_ct = seq(1,length(fp_nit_analysis$concentration)/4),
                         nit_pred = 0)

for (i in 1:length(fp_nit_day$day_ct)){
  fp_nit_day$nit_pred[i] =  (fp_nit_analysis$concentration[(4*i)-3]+fp_nit_analysis$concentration[(4*i)-2]+ fp_nit_analysis$concentration[(4*i)-1]+fp_nit_analysis$concentration[4*i])/4
}

# create daily averages for ammonium concentrations modeled in the fishpond water
fp_amm_day <- data.frame(day_ct = seq(1,length(fp_amm_analysis$concentration)),
                         amm_pred = 0)

for (i in 1:length(fp_amm_day$day_ct)){
  fp_amm_day$amm_pred[i] =  (fp_amm_analysis$concentration[(4*i)-3]+fp_amm_analysis$concentration[(4*i)-2]+ fp_amm_analysis$concentration[(4*i)-1]+fp_amm_analysis$concentration[4*i])/4
}

```

```{r}
# Merge the data frames 
amm_mse_df <- merge(ammonium_data, fp_amm_day, by = "day_ct")
nit_mse_df <- merge(nitrate_data, fp_nit_day, by = "day_ct")
```


```{r}
# checked this MSE function and it calculates the expected outcome
amm_mse = MSE(y_pred = amm_mse_df$amm_pred, y_true = amm_mse_df$amm_obs) 
nit_mse = MSE(y_pred = nit_mse_df$nit_pred, y_true = nit_mse_df$nit_obs)

# Nash-Sutcliffe Efficiency (NSE) is considered teh normalized MSE
# NSE = 1 - ( sum( (obs - sim)^2 ) / sum( (obs - mean(obs))^2 )
#Nash-Sutcliffe efficiencies range from -Inf to 1. Essentially, the closer to 1, the more accurate the model is. 
#-) NSE = 1, corresponds to a perfect match of modelled to the observed data. 
#-) NSE = 0, indicates that the model predictions are as accurate as the mean of the observed data, 
#-) -Inf < NSE < 0, indicates that the observed mean is better predictor than the model.

amm_var_mean = mean(amm_mse_df$amm_var)
nit_var_mean = mean(nit_mse_df$nit_var)

amm_nse = 1 - (amm_mse/amm_var_mean)
nit_nse = 1 - (nit_mse/nit_var_mean)

amm_nse # problematic that this is negative
nit_nse # probelmatic that this isn't that close to 1

# NSE seems to be used extensively in hydrologic models

# just by removing the outlier in the ammonium data set, the NSE went from  -1.138588 to 0.575
```

```{r}
amm_nse_plot <- ggplot(data = amm_mse_df) +
  geom_point(aes(x = day_ct, y = amm_obs),col='magenta') +
  geom_errorbar(aes(x = day_ct, ymin=amm_obs-amm_sd, ymax=amm_obs+amm_sd), width=3, col='magenta') +
  geom_point(aes(x = day_ct, y = amm_pred),col='blue') +
  labs(x = 'Time (Days)', y = 'Concentration (mg/L)') +
  theme(axis.text.x= element_text(size = 8), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5))

amm_nse_plot
```



Total food production from the He‘eia IAAS

Examine 10 year intervals for all land use scenarios. In the case of the restored scenario, the 10 years begin after 20 years of restoration are completed. Similarly for the urban land use scenario, the nitrogen loading used throughout the evaluated 10 year interval is constant, representing the loading from complete urbanization of the present.



Agriculture production


#make sure that this is working correctly
```{r}
current_catch <- df_control %>% 
  dplyr::select(time, caught_kg) %>% 
  mutate(yr_curr = ceiling(time)) %>% 
  filter(yr_curr > 1400)

# do some group_by and summarize
current_catch_annual = current_catch %>% 
  group_by(yr_curr) %>% 
  summarise(catch_tons = sum(caught_kg)/1e3)


restored_catch <- df_restored %>% 
  dplyr::select(time, caught_kg)%>% 
  mutate(yr_curr = ceiling(time)) %>% 
  filter(yr_curr > 1400)

# do some group_by and summarize
restored_catch_annual = restored_catch %>% 
  group_by(yr_curr) %>% 
  summarise(catch_tons = sum(caught_kg)/1e3)


urban_catch <- df_urban %>% 
  dplyr::select(time, caught_kg)%>% 
  mutate(yr_curr = ceiling(time)) %>% 
  filter(yr_curr > 1400)

# do some group_by and summarize
urban_catch_annual = urban_catch %>% 
  group_by(yr_curr) %>% 
  summarise(catch_tons = sum(caught_kg)/1e3)


```



```{r}
eval_years = 100
rest_time = seq(1,eval_years) # specify the time frame of the years of interest

rest_time[21:100] = 20 # the restoration is anticipated to take 20 years. After that point, no new area is added

tframe = seq(1,eval_years)

# Use the mean of the range of the yield values for the three different crops
banana_yield = 1.27/1e3 # medium yield tons/m^2 (min,max) = 0.58-2.39 kg/m^2 from Bremer, et al (2018)
breadfruit_yield = 1.03/1e3 # medium yield tons/m^2 based on medium tree density from Bremer, et al (2018)
taro_yield = 1.46/1e3 # mean of 1.12-1.79 kg/yr from Bremer, et al (2018)

banana_annual_add = 2428 # [m^2/yr]
breadfruit_annual_add = 4856 # [m^2/yr]
taro_annual_add = 6475 # [m^2/yr]

banana_area_current = 0 # [m^2] current banana production area
breadfruit_area_current = 0 # [m^2] current breadfruit production area
taro_area_current = 7300 # [m^2] current taro production area

# current land use mass [kg]
banana_current_mass = rep(banana_area_current*banana_yield, eval_years)
breadfruit_current_mass = rep(breadfruit_area_current*breadfruit_yield, eval_years)
taro_current_mass = rep(taro_area_current*taro_yield, eval_years)

# restored land use mass [kg]
banana_rest_mass = (banana_area_current + banana_annual_add*rest_time)*banana_yield 
breadfruit_rest_mass = (breadfruit_area_current + breadfruit_annual_add*rest_time)*breadfruit_yield 
taro_rest_mass = (taro_area_current + taro_annual_add*rest_time)*taro_yield 

# urban land use mass [kg]
banana_urban_mass = rep(0, eval_years)  # constantly 0, no food production
breadfruit_urban_mass = rep(0, eval_years)  # constantly 0, no food production
taro_urban_mass = rep(0, eval_years)  # constantly 0, no food production

Crop=c(rep("Taro", 3*(eval_years)), rep("Banana", 3*(eval_years)), rep("Breadfruit", 3*(eval_years)), rep("Fish", 3*(eval_years)))
Scenario =rep(c("Current", "Restored", "Urban") , each = eval_years, times = 4)
Mass= c(taro_current_mass, taro_rest_mass, taro_urban_mass, banana_current_mass, banana_rest_mass, banana_urban_mass, breadfruit_current_mass, breadfruit_rest_mass, breadfruit_urban_mass, current_catch_annual$catch_tons, restored_catch_annual$catch_tons, urban_catch_annual$catch_tons) # convert all the kg masses to metric tons
Time = as.numeric(rep(tframe, times = 12))

crop_data=data.frame(Time,Crop,Scenario,Mass)

```


 
```{r}
crop_levels <- c('Banana', 'Breadfruit','Taro', 'Fish')

crop_data_forplot <- crop_data %>% 
  transform(Crop=factor(Crop,levels=crop_levels)) %>% 
  filter(Time <= 20)

# Stacked
crop_stacked <- ggplot(crop_data_forplot, aes(fill = Crop, y=Mass, x=Time)) + 
    geom_bar(stat="identity") +
    facet_wrap(~Scenario) +
    scale_fill_discrete_qualitative(palette = "Cold") +
    guides(fill=guide_legend()) +
    labs(y = "Metric Tons", x = "Years") +
    scale_x_continuous(expand = c(0, 0)) + 
    scale_y_continuous(expand = c(0, 0)) +
    theme(axis.text.x= element_text(size = 8, hjust = .2), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5), legend.title.align = 0.5, strip.background = element_blank())

crop_stacked # difficult to see the mass from fish catch
```


```{r}
crop_data_forplot$source[crop_data_forplot$Crop == "Banana"] <- "Ag"
crop_data_forplot$source[crop_data_forplot$Crop == "Breadfruit"] <- "Ag"
crop_data_forplot$source[crop_data_forplot$Crop == "Taro"] <- "Ag"
crop_data_forplot$source[crop_data_forplot$Crop == "Fish"] <- "Aq"
```

```{r}
crop_summary <- crop_data_forplot %>% 
  filter(Time < 21) %>% 
  group_by(Scenario, source) %>% 
  summarise(tons = sum(Mass))
```

```{r}
crop_percentplot <- ggplot(crop_data_forplot, aes(fill = Crop, y=Mass, x=Time)) + 
    geom_bar(position = "fill", stat="identity") +
    facet_wrap(~Scenario) +
    #scale_fill_discrete_qualitative(palette = "Cold") +
    guides(fill=guide_legend()) +
    labs(y = "Fration of Total Production", x = "Years") +
    scale_x_continuous(expand = c(0, 0)) + 
    scale_y_continuous(expand = c(0, 0)) +
    theme(axis.text.x= element_text(size = 8, hjust = .2), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title = element_text(hjust = 0.5), legend.title.align = 0.5, strip.background = element_blank())

crop_percentplot
```

```{r}
crop_curr <- crop_data %>% 
  filter(Scenario == "Current") %>% 
  dplyr::select(Time, Mass) %>%
  colSums()

crop_rest <- crop_data %>% 
  filter(Scenario == "Restored") %>% 
  dplyr::select(Time, Mass) %>%
  colSums()

crop_urban <- crop_data %>% 
  filter(Scenario == "Urban") %>% 
  dplyr::select(Time, Mass) %>%
  colSums()


```



